<script type="module">
    import { WebXRButton } from './js/util/webxr-button.js';
    import { Scene } from './js/render/scenes/scene.js';
    import { Renderer, createWebGLContext } from './js/render/core/renderer.js';
    import { URDFLoader } from './js/util/URDFLoader.js'; 
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.module.js';
    import { XRControllerModelFactory } from 'https://cdn.jsdelivr.net/npm/three@0.136.0/examples/jsm/webxr/XRControllerModelFactory.js';
    
    // Global variables
    let xrButton, xrRefSpace, scene, renderer, robotModel;

    // Initialize the scene and AR setup
    function initAR() {
        // Create a WebXR button for starting AR
        xrButton = new WebXRButton({
            onRequestSession: onRequestSession,
            onEndSession: onEndSession,
            textEnterXRTitle: "Enter AR",
            textXRNotFoundTitle: "AR Not Found",
        });
        document.body.appendChild(xrButton.domElement);

        // Create a scene and renderer
        scene = new Scene();
        const gl = createWebGLContext({ xrCompatible: true });
        renderer = new Renderer(gl);

        scene.setRenderer(renderer);

        // Check for AR support and enable the button
        if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                if (supported) {
                    xrButton.enabled = supported;
                }
            });
        }
    }

    // Function to handle AR session request
    function onRequestSession() {
        return navigator.xr.requestSession('immersive-ar', {
            optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking']
        }).then(onSessionStarted);
    }

    // Function to handle session start
    function onSessionStarted(session) {
        xrButton.setSession(session);
        session.addEventListener('end', onEndSession);
        session.requestReferenceSpace('local').then((refSpace) => {
            xrRefSpace = refSpace;
            session.requestAnimationFrame(onXRFrame);
        });

        // Load the URDF model into the scene
        loadURDFModel();
    }

    // Load the URDF model into the AR scene
    function loadURDFModel() {
        const loader = new URDFLoader();
        loader.load('/Users/boris/Documents/human-retargeting/web/my-ar-template/assets/xarm6/xarm6_wo_ee.urdf', (result) => {
            robotModel = result;
            scene.add(robotModel);
            robotModel.position.set(0, 0, 0);  // Adjust position as needed
        });
    }

    // Function to handle session end
    function onEndSession(session) {
        session.end();
    }

    // AR frame update (rendering and updating the robot model)
    function onXRFrame(t, frame) {
        let session = frame.session;
        scene.startFrame();
        session.requestAnimationFrame(onXRFrame);

        let pose = frame.getViewerPose(xrRefSpace);
        if (pose) {
            const glLayer = session.renderState.baseLayer;
            gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            for (let view of pose.views) {
                let viewport = glLayer.getViewport(view);
                gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
                scene.draw(view.projectionMatrix, view.transform);
            }
        }

        scene.endFrame();
    }

    // Initialize the AR session and scene
    initAR();
</script>